---
# ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{APP_NAME}}-config
  namespace: {{NAMESPACE}}
data:
  cors-origins: "{{CORS_ORIGINS}}"
  app-name: "{{APP_NAME}}"
  debug: "{{DEBUG}}"
  jwt-algorithm: "{{JWT_ALGORITHM}}"
  jwt-access-token-expire-minutes: "{{JWT_ACCESS_TOKEN_EXPIRE_MINUTES}}"

---
# Secret
apiVersion: v1
kind: Secret
metadata:
  name: {{APP_NAME}}-secrets
  namespace: {{NAMESPACE}}
type: Opaque
stringData:
  database-url: "{{DATABASE_URL}}"
  jwt-secret: "{{JWT_SECRET}}"
  {{#if GROQ_API_KEY}}
  groq-api-key: "{{GROQ_API_KEY}}"
  {{/if}}
  {{#if GEMINI_API_KEY}}
  gemini-api-key: "{{GEMINI_API_KEY}}"
  {{/if}}

---
# Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{APP_NAME}}
  namespace: {{NAMESPACE}}
  labels:
    app.kubernetes.io/name: {{APP_NAME}}
    app.kubernetes.io/component: {{COMPONENT}}
spec:
  replicas: {{REPLICAS}}
  selector:
    matchLabels:
      app.kubernetes.io/name: {{APP_NAME}}
  template:
    metadata:
      labels:
        app.kubernetes.io/name: {{APP_NAME}}
    spec:
      {{#if IMAGE_PULL_SECRETS}}
      imagePullSecrets:
      - name: {{IMAGE_PULL_SECRETS}}
      {{/if}}
      containers:
      - name: {{CONTAINER_NAME}}
        image: {{IMAGE}}:{{TAG}}
        imagePullPolicy: {{IMAGE_PULL_POLICY}}
        ports:
        - name: http
          containerPort: {{CONTAINER_PORT}}
          protocol: TCP
        env:
        {{#each ENV_VARS}}
        - name: {{@key}}
          value: {{this}}
        {{/each}}
        {{#each SECRET_ENV_VARS}}
        - name: {{@key}}
          valueFrom:
            secretKeyRef:
              name: {{SECRET_NAME}}
              key: {{this}}
        {{/each}}
        livenessProbe:
          httpGet:
            path: {{HEALTH_PATH}}
            port: http
          initialDelaySeconds: {{LIVENESS_INITIAL_DELAY}}
          periodSeconds: {{LIVENESS_PERIOD}}
          timeoutSeconds: {{LIVENESS_TIMEOUT}}
          failureThreshold: {{LIVENESS_FAILURE_THRESHOLD}}
        readinessProbe:
          httpGet:
            path: {{READYNESS_PATH}}
            port: http
          initialDelaySeconds: {{READYNESS_INITIAL_DELAY}}
          periodSeconds: {{READYNESS_PERIOD}}
          timeoutSeconds: {{READYNESS_TIMEOUT}}
          failureThreshold: {{READYNESS_FAILURE_THRESHOLD}}
        resources:
          requests:
            memory: "{{MEMORY_REQUEST}}"
            cpu: "{{CPU_REQUEST}}"
          limits:
            memory: "{{MEMORY_LIMIT}}"
            cpu: "{{CPU_LIMIT}}"
        securityContext:
          runAsNonRoot: true
          runAsUser: 1001
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL

---
# Service
apiVersion: v1
kind: Service
metadata:
  name: {{APP_NAME}}
  namespace: {{NAMESPACE}}
  labels:
    app.kubernetes.io/name: {{APP_NAME}}
    app.kubernetes.io/component: {{COMPONENT}}
spec:
  type: {{SERVICE_TYPE}}
  ports:
  - port: {{SERVICE_PORT}}
    targetPort: http
    protocol: TCP
    name: http
    {{#if NODE_PORT}}
    nodePort: {{NODE_PORT}}
    {{/if}}
  selector:
    app.kubernetes.io/name: {{APP_NAME}}

---
# HorizontalPodAutoscaler (Optional)
{{#if ENABLE_HPA}}
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{APP_NAME}}
  namespace: {{NAMESPACE}}
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{APP_NAME}}
  minReplicas: {{MIN_REPLICAS}}
  maxReplicas: {{MAX_REPLICAS}}
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: {{TARGET_CPU_UTILIZATION}}
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: {{TARGET_MEMORY_UTILIZATION}}
{{/if}}
