name: Backend CI/CD - Deploy to DOKS

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - 'tests/**'
      - '.github/workflows/backend-deploy.yml'
      - 'helm/backend/**'
  pull_request:
    branches:
      - main
    paths:
      - 'backend/**'
      - 'tests/**'
      - 'helm/backend/**'
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests (true/false)'
        required: false
        default: 'false'

env:
  REGISTRY: registry.digitalocean.com/todo-chatbot-reg
  IMAGE_NAME: todo-backend
  HELM_CHART_PATH: helm/backend
  CLUSTER_NAME: do-fra1-hackathon2h1
  CLUSTER_REGION: fra1
  NAMESPACE: production

jobs:
  # =============================================================================
  # CI: Test Backend Code
  # =============================================================================
  test:
    name: Test Backend
    if: github.event.inputs.skip_tests != 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'
          cache-dependency-path: 'backend/requirements.txt'

      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov httpx

      - name: Run unit tests
        working-directory: ./backend
        run: |
          pytest tests/ -v \
            --cov=app \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --tb=short \
            -k "not (e2e or production or deployed)"

      - name: Run integration tests
        working-directory: ./backend
        run: |
          pytest tests/ -v \
            -k "integration" \
            --tb=short \
            -x || echo "No integration tests found or tests failed"

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./backend/coverage.xml
          flags: backend
          name: backend-coverage
          fail_ci_if_error: false

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage-report
          path: backend/htmlcov/
          retention-days: 7

  # =============================================================================
  # CI: Lint and Security Scan
  # =============================================================================
  lint:
    name: Lint & Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install linting tools
        run: |
          pip install ruff bandit safety

      - name: Run Ruff linter
        working-directory: ./backend
        run: |
          ruff check . --output-format=github || true

      - name: Run Bandit security linter
        working-directory: ./backend
        run: |
          bandit -r app/ -f json -o bandit-report.json || true
          bandit -r app/

      - name: Check dependencies for vulnerabilities
        working-directory: ./backend
        run: |
          pip install -r requirements.txt
          safety check --json --output safety-report.json || true
          safety check || true

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: backend-security-reports
          path: |
            backend/bandit-report.json
            backend/safety-report.json
          retention-days: 30

  # =============================================================================
  # CI: Build Docker Image
  # =============================================================================
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [test, lint]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to DigitalOcean Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DO_REGISTRY_USERNAME }}
          password: ${{ secrets.DO_REGISTRY_ACCESS_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
          flavor: |
            latest=true

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ github.sha }}

      - name: Image digest
        run: echo ${{ steps.build.outputs.digest }}

  # =============================================================================
  # CD: Deploy to DOKS
  # =============================================================================
  deploy:
    name: Deploy to DigitalOcean Kubernetes
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://api.testservers.online

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Configure kubectl for DOKS cluster
        run: |
          doctl kubernetes cluster kubeconfig save ${{ env.CLUSTER_NAME }}
          kubectl config current-context
          kubectl cluster-info

      - name: Verify namespace exists
        run: |
          kubectl create namespace ${{ env.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Verify image pull secret exists
        run: |
          kubectl get secret registry-pull-secret -n ${{ env.NAMESPACE }} || \
          kubectl create secret docker-registry registry-pull-secret \
            --docker-server=${{ env.REGISTRY }} \
            --docker-username=${{ secrets.DO_REGISTRY_USERNAME }} \
            --docker-password=${{ secrets.DO_REGISTRY_ACCESS_TOKEN }} \
            -n ${{ env.NAMESPACE }}

      - name: Lint Helm chart
        run: |
          helm lint ${{ env.HELM_CHART_PATH }} \
            --set image.tag=${{ github.sha }}

      - name: Deploy with Helm (Dry Run)
        run: |
          helm upgrade --install todo-backend ${{ env.HELM_CHART_PATH }} \
            --namespace ${{ env.NAMESPACE }} \
            --set image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} \
            --set image.tag=${{ github.sha }} \
            --set image.pullPolicy=Always \
            --debug \
            --dry-run

      - name: Deploy with Helm
        run: |
          helm upgrade --install todo-backend ${{ env.HELM_CHART_PATH }} \
            --namespace ${{ env.NAMESPACE }} \
            --set image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} \
            --set image.tag=${{ github.sha }} \
            --set image.pullPolicy=Always \
            --wait \
            --timeout 10m \
            --atomic \
            --cleanup-on-fail \
            --history-max 5

      - name: Get Helm release status
        run: |
          helm status todo-backend -n ${{ env.NAMESPACE }}

      - name: Verify deployment rollout
        run: |
          kubectl rollout status deployment/todo-backend -n ${{ env.NAMESPACE }} --timeout=5m

      - name: Get deployment info
        run: |
          echo "=== Deployment Status ==="
          kubectl get deployments -n ${{ env.NAMESPACE }} -l app.kubernetes.io/name=backend
          echo ""
          echo "=== Pods ==="
          kubectl get pods -n ${{ env.NAMESPACE }} -l app.kubernetes.io/name=backend
          echo ""
          echo "=== Services ==="
          kubectl get services -n ${{ env.NAMESPACE }} -l app.kubernetes.io/name=backend
          echo ""
          echo "=== Events (Last 10) ==="
          kubectl get events -n ${{ env.NAMESPACE }} --sort-by='.lastTimestamp' | tail -n 10

      - name: Run smoke tests
        run: |
          # Wait for pods to be ready
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=backend -n ${{ env.NAMESPACE }} --timeout=60s

          # Get service endpoint (NodePort)
          NODE_PORT=$(kubectl get service todo-backend -n ${{ env.NAMESPACE }} -o jsonpath='{.spec.ports[0].nodePort}')
          NODE_IP=$(kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="ExternalIP")].address}')
          if [ -z "$NODE_IP" ]; then
            NODE_IP=$(kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="InternalIP")].address}')
          fi

          echo "Testing health endpoint at http://${NODE_IP}:${NODE_PORT}/health"
          curl -f --retry 5 --retry-delay 10 --max-time 30 http://${NODE_IP}:${NODE_PORT}/health || exit 1

      - name: Check pod logs for errors
        if: always()
        run: |
          echo "=== Backend Pod Logs (Last 50 lines) ==="
          kubectl logs -n ${{ env.NAMESPACE }} -l app.kubernetes.io/name=backend --tail=50 || true

      - name: Create deployment annotation
        run: |
          kubectl annotate deployment todo-backend \
            -n ${{ env.NAMESPACE }} \
            deployment.kubernetes.io/revision="${{ github.sha }}" \
            deployment.github.com/run="${{ github.run_number }}" \
            deployment.github.com/actor="${{ github.actor }}" \
            deployment.github.com/date="$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            --overwrite

  # =============================================================================
  # CD: Rollback on Failure
  # =============================================================================
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    needs: [deploy]
    if: failure()
    environment:
      name: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Configure kubectl for DOKS cluster
        run: |
          doctl kubernetes cluster kubeconfig save ${{ env.CLUSTER_NAME }}

      - name: Helm rollback
        run: |
          helm rollback todo-backend -n ${{ env.NAMESPACE }}

      - name: Verify rollback
        run: |
          kubectl rollout status deployment/todo-backend -n ${{ env.NAMESPACE }} --timeout=5m

      - name: Notify rollback
        run: |
          echo "Deployment rolled back due to failure!"
          echo "Previous release restored successfully."

  # =============================================================================
  # Post-Deployment: Health Check
  # =============================================================================
  health-check:
    name: Post-Deployment Health Check
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always() && needs.deploy.result == 'success'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Configure kubectl for DOKS cluster
        run: |
          doctl kubernetes cluster kubeconfig save ${{ env.CLUSTER_NAME }}

      - name: Run health checks
        run: |
          # Wait for deployment to stabilize
          sleep 30

          # Check pod health
          kubectl get pods -n ${{ env.NAMESPACE }} -l app.kubernetes.io/name=backend

          # Exec health check inside pod
          POD_NAME=$(kubectl get pods -n ${{ env.NAMESPACE }} -l app.kubernetes.io/name=backend -o jsonpath='{.items[0].metadata.name}')
          kubectl exec -n ${{ env.NAMESPACE }} $POD_NAME -- curl -f http://localhost:8000/health || exit 1

      - name: Verify metrics endpoint
        run: |
          POD_NAME=$(kubectl get pods -n ${{ env.NAMESPACE }} -l app.kubernetes.io/name=backend -o jsonpath='{.items[0].metadata.name}')
          kubectl exec -n ${{ env.NAMESPACE }} $POD_NAME -- curl -f http://localhost:8000/analytics/stats || echo "Metrics endpoint check"

      - name: Deployment summary
        run: |
          echo "### Backend Deployment Summary :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Image Tag | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Namespace | \`${{ env.NAMESPACE }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Cluster | \`${{ env.CLUSTER_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployed by | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Kubernetes Resources" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          kubectl get all -n ${{ env.NAMESPACE }} -l app.kubernetes.io/name=backend >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
