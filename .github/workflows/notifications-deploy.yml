name: Notifications CI/CD - Deploy to DOKS

on:
  push:
    branches:
      - main
    paths:
      - 'services/notifications/**'
      - '.github/workflows/notifications-deploy.yml'
      - 'helm/notifications/**'
  pull_request:
    branches:
      - main
    paths:
      - 'services/notifications/**'
      - 'helm/notifications/**'
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests (true/false)'
        required: false
        default: 'false'

env:
  REGISTRY: registry.digitalocean.com/todo-chatbot-reg
  IMAGE_NAME: notification-service
  SERVICE_PATH: services/notifications
  HELM_CHART_PATH: helm/notifications
  CLUSTER_NAME: do-fra1-hackathon2h1
  CLUSTER_REGION: fra1
  NAMESPACE: production

jobs:
  # =============================================================================
  # CI: Test Notification Service
  # =============================================================================
  test:
    name: Test Notification Service
    if: github.event.inputs.skip_tests != 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'
          cache-dependency-path: 'services/notifications/requirements.txt'

      - name: Install dependencies
        working-directory: ./services/notifications
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov httpx

      - name: Run unit tests
        working-directory: ./services/notifications
        run: |
          pytest tests/ -v \
            --cov=app \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --tb=short \
            -k "not (e2e or production or deployed)"

      - name: Run integration tests
        working-directory: ./services/notifications
        run: |
          pytest tests/ -v \
            -k "integration" \
            --tb=short \
            -x || echo "No integration tests found or tests failed"

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./services/notifications/coverage.xml
          flags: notifications
          name: notifications-coverage
          fail_ci_if_error: false

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: notifications-coverage-report
          path: services/notifications/htmlcov/
          retention-days: 7

  # =============================================================================
  # CI: Lint and Security Scan
  # =============================================================================
  lint:
    name: Lint & Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install linting tools
        run: |
          pip install ruff bandit safety

      - name: Run Ruff linter
        working-directory: ./services/notifications
        run: |
          ruff check . --output-format=github || true

      - name: Run Bandit security linter
        working-directory: ./services/notifications
        run: |
          bandit -r app/ -f json -o bandit-report.json || true
          bandit -r app/

      - name: Check dependencies for vulnerabilities
        working-directory: ./services/notifications
        run: |
          pip install -r requirements.txt
          safety check --json --output safety-report.json || true
          safety check || true

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: notifications-security-reports
          path: |
            services/notifications/bandit-report.json
            services/notifications/safety-report.json
          retention-days: 30

  # =============================================================================
  # CI: Dapr Configuration Validation
  # =============================================================================
  validate-dapr:
    name: Validate Dapr Configuration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Dapr CLI
        run: |
          wget -q https://raw.githubusercontent.com/dapr/cli/master/install/install.sh -O - | /bin/bash -s ${{ env.DAPR_VERSION || 'v1.14.0' }}

      - name: Validate Dapr manifests
        run: |
          # Check if dapr directory exists
          if [ -d "k8s/dapr" ]; then
            echo "Validating Dapr component manifests..."
            find k8s/dapr -name "*.yaml" -exec echo "Checking {}" \; -exec kubectl --dry-run=client apply -f {} \;
          else
            echo "No Dapr manifests found in k8s/dapr/"
          fi

      - name: Validate Helm Dapr annotations
        run: |
          echo "Checking Helm chart for Dapr configuration..."
          if grep -q "dapr.io/enabled" ${{ env.HELM_CHART_PATH }}/templates/deployment.yaml; then
            echo "Dapr annotation found in Helm chart"
          else
            echo "Warning: Dapr annotation not found in deployment template"
          fi

  # =============================================================================
  # CI: Build Docker Image
  # =============================================================================
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [test, lint, validate-dapr]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to DigitalOcean Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DO_REGISTRY_USERNAME }}
          password: ${{ secrets.DO_REGISTRY_ACCESS_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
          flavor: |
            latest=true

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./services/notifications
          file: ./services/notifications/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ github.sha }}

      - name: Image digest
        run: echo ${{ steps.build.outputs.digest }}

      - name: Scan image for vulnerabilities (Trivy)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # =============================================================================
  # CD: Deploy to DOKS
  # =============================================================================
  deploy:
    name: Deploy to DigitalOcean Kubernetes
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://api.testservers.online

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Install Dapr CLI
        run: |
          wget -q https://raw.githubusercontent.com/dapr/cli/master/install/install.sh -O - | /bin/bash -s v1.14.0
          dapr version

      - name: Configure kubectl for DOKS cluster
        run: |
          doctl kubernetes cluster kubeconfig save ${{ env.CLUSTER_NAME }}
          kubectl config current-context
          kubectl cluster-info

      - name: Verify Dapr installation on cluster
        run: |
          kubectl get pods -n dapr-system
          kubectl get deployment dapr-sidecar-injector -n dapr-system

      - name: Verify namespace exists
        run: |
          kubectl create namespace ${{ env.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Verify image pull secret exists
        run: |
          kubectl get secret registry-pull-secret -n ${{ env.NAMESPACE }} || \
          kubectl create secret docker-registry registry-pull-secret \
            --docker-server=${{ env.REGISTRY }} \
            --docker-username=${{ secrets.DO_REGISTRY_USERNAME }} \
            --docker-password=${{ secrets.DO_REGISTRY_ACCESS_TOKEN }} \
            -n ${{ env.NAMESPACE }}

      - name: Create/Update Dapr components
        run: |
          # Apply Dapr pub/sub component if exists
          if [ -f "k8s/dapr/pubsub.yaml" ]; then
            kubectl apply -f k8s/dapr/pubsub.yaml
          fi

          # Apply Dapr state store component if exists
          if [ -f "k8s/dapr/statestore.yaml" ]; then
            kubectl apply -f k8s/dapr/statestore.yaml
          fi

          # List all Dapr components
          echo "Current Dapr components:"
          kubectl get dapr components -n ${{ env.NAMESPACE }} || echo "No Dapr components found"

      - name: Lint Helm chart
        run: |
          helm lint ${{ env.HELM_CHART_PATH }} \
            --set image.tag=${{ github.sha }}

      - name: Deploy with Helm (Dry Run)
        run: |
          helm upgrade --install todo-notifications ${{ env.HELM_CHART_PATH }} \
            --namespace ${{ env.NAMESPACE }} \
            --set image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} \
            --set image.tag=${{ github.sha }} \
            --set image.pullPolicy=Always \
            --debug \
            --dry-run

      - name: Deploy with Helm
        run: |
          helm upgrade --install todo-notifications ${{ env.HELM_CHART_PATH }} \
            --namespace ${{ env.NAMESPACE }} \
            --set image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} \
            --set image.tag=${{ github.sha }} \
            --set image.pullPolicy=Always \
            --wait \
            --timeout 10m \
            --atomic \
            --cleanup-on-fail \
            --history-max 5

      - name: Get Helm release status
        run: |
          helm status todo-notifications -n ${{ env.NAMESPACE }}

      - name: Verify Dapr sidecar injection
        run: |
          # Check that pods have Dapr sidecar
          kubectl get pods -n ${{ env.NAMESPACE }} -l app.kubernetes.io/name=notifications
          POD_NAME=$(kubectl get pods -n ${{ env.NAMESPACE }} -l app.kubernetes.io/name=notifications -o jsonpath='{.items[0].metadata.name}')
          echo "Checking Dapr sidecar in pod: $POD_NAME"
          kubectl get pod $POD_NAME -n ${{ env.NAMESPACE }} -o jsonpath='{.spec.containers[*].name}'

      - name: Verify deployment rollout
        run: |
          kubectl rollout status deployment/todo-notifications -n ${{ env.NAMESPACE }} --timeout=5m

      - name: Get deployment info
        run: |
          echo "=== Deployment Status ==="
          kubectl get deployments -n ${{ env.NAMESPACE }} -l app.kubernetes.io/name=notifications
          echo ""
          echo "=== Pods ==="
          kubectl get pods -n ${{ env.NAMESPACE }} -l app.kubernetes.io/name=notifications
          echo ""
          echo "=== Services ==="
          kubectl get services -n ${{ env.NAMESPACE }} -l app.kubernetes.io/name=notifications
          echo ""
          echo "=== Dapr Components ==="
          kubectl get dapr components -n ${{ env.NAMESPACE }} || echo "No Dapr components"
          echo ""
          echo "=== Events (Last 10) ==="
          kubectl get events -n ${{ env.NAMESPACE }} --sort-by='.lastTimestamp' | tail -n 10

      - name: Run smoke tests
        run: |
          # Wait for pods to be ready
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=notifications -n ${{ env.NAMESPACE }} --timeout=60s

          # Port-forward to test locally
          POD_NAME=$(kubectl get pods -n ${{ env.NAMESPACE }} -l app.kubernetes.io/name=notifications -o jsonpath='{.items[0].metadata.name}')
          kubectl port-forward -n ${{ env.NAMESPACE }} $POD_NAME 8080:8000 &
          PF_PID=$!
          sleep 5

          # Test health endpoint
          curl -f --retry 5 --retry-delay 2 --max-time 30 http://localhost:8080/health || exit 1

          # Kill port-forward
          kill $PF_PID

      - name: Check pod logs for errors
        if: always()
        run: |
          echo "=== Notification Service Pod Logs (Last 50 lines) ==="
          kubectl logs -n ${{ env.NAMESPACE }} -l app.kubernetes.io/name=notifications --tail=50 || true

      - name: Check Dapr sidecar logs
        if: always()
        run: |
          echo "=== Dapr Sidecar Logs (Last 50 lines) ==="
          POD_NAME=$(kubectl get pods -n ${{ env.NAMESPACE }} -l app.kubernetes.io/name=notifications -o jsonpath='{.items[0].metadata.name}')
          kubectl logs -n ${{ env.NAMESPACE }} $POD_NAME -c daprd --tail=50 || true

      - name: Create deployment annotation
        run: |
          kubectl annotate deployment todo-notifications \
            -n ${{ env.NAMESPACE }} \
            deployment.kubernetes.io/revision="${{ github.sha }}" \
            deployment.github.com/run="${{ github.run_number }}" \
            deployment.github.com/actor="${{ github.actor }}" \
            deployment.github.com/date="$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            --overwrite

  # =============================================================================
  # CD: Rollback on Failure
  # =============================================================================
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    needs: [deploy]
    if: failure()
    environment:
      name: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Configure kubectl for DOKS cluster
        run: |
          doctl kubernetes cluster kubeconfig save ${{ env.CLUSTER_NAME }}

      - name: Helm rollback
        run: |
          helm rollback todo-notifications -n ${{ env.NAMESPACE }}

      - name: Verify rollback
        run: |
          kubectl rollout status deployment/todo-notifications -n ${{ env.NAMESPACE }} --timeout=5m

      - name: Notify rollback
        run: |
          echo "Deployment rolled back due to failure!"
          echo "Previous release restored successfully."

  # =============================================================================
  # Post-Deployment: Health Check
  # =============================================================================
  health-check:
    name: Post-Deployment Health Check
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always() && needs.deploy.result == 'success'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Install Dapr CLI
        run: |
          wget -q https://raw.githubusercontent.com/dapr/cli/master/install/install.sh -O - | /bin/bash -s v1.14.0

      - name: Configure kubectl for DOKS cluster
        run: |
          doctl kubernetes cluster kubeconfig save ${{ env.CLUSTER_NAME }}

      - name: Run health checks
        run: |
          # Wait for deployment to stabilize
          sleep 30

          # Check pod health
          kubectl get pods -n ${{ env.NAMESPACE }} -l app.kubernetes.io/name=notifications

          # Check Dapr sidecar health
          POD_NAME=$(kubectl get pods -n ${{ env.NAMESPACE }} -l app.kubernetes.io/name=notifications -o jsonpath='{.items[0].metadata.name}')
          dapr health -k ${{ env.NAMESPACE }}

          # Exec health check inside pod
          kubectl exec -n ${{ env.NAMESPACE }} $POD_NAME -- curl -f http://localhost:8000/health || exit 1

      - name: Test Dapr service invocation
        run: |
          # List Dapr enabled services
          dapr list -k

          # Check if notifications service is Dapr-enabled
          POD_NAME=$(kubectl get pods -n ${{ env.NAMESPACE }} -l app.kubernetes.io/name=notifications -o jsonpath='{.items[0].metadata.name}')
          kubectl get pod $POD_NAME -n ${{ env.NAMESPACE }} -o jsonpath='{.metadata.annotations}' | grep "dapr" || echo "Dapr annotations not found"

      - name: Deployment summary
        run: |
          echo "### Notification Service Deployment Summary :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Image Tag | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Namespace | \`${{ env.NAMESPACE }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Cluster | \`${{ env.CLUSTER_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Dapr Enabled | :white_check_mark: |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployed by | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Kubernetes Resources" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          kubectl get all -n ${{ env.NAMESPACE }} -l app.kubernetes.io/name=notifications >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
